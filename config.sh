#!/bin/bash

echo "üì° CONFIGURANDO HOTSPOT FUNCIONAL + CAPTIVE PORTAL"
echo "=================================================="

# Configuraci√≥n
INTERFACE="wlp2s0"
SSID="MiPortal"
PASSWORD="portal123"
GATEWAY_IP="192.168.4.1"
SERVER_PORT="8000"

# Funci√≥n de limpieza
cleanup() {
    echo ""
    echo "üßπ Limpiando configuraci√≥n..."
    sudo pkill hostapd 2>/dev/null
    sudo pkill dnsmasq 2>/dev/null
    sudo pkill -f "python3 server_hotspot.py" 2>/dev/null
    sudo systemctl restart NetworkManager 2>/dev/null
    sudo systemctl restart systemd-resolved 2>/dev/null

    sudo iptables -t nat -F 2>/dev/null
    sudo iptables -F 2>/dev/null
    sudo pkill dnsmasq
    sudo pkill hostapd
    sudo rm -f /tmp/dnsmasq.log
    sudo rm -f /tmp/dhcp.leases

    sudo touch /tmp/dnsmasq.log
    sudo chmod 666 /tmp/dnsmasq.log
    sudo touch /tmp/dhcp.leases
    sudo chmod 666 /tmp/dhcp.leases

    sudo ip addr flush dev $INTERFACE 2>/dev/null
    sudo ip link set $INTERFACE down 2>/dev/null
    sudo ip link set $INTERFACE up 2>/dev/null

    echo "‚úÖ Configuraci√≥n limpiada"
}

# Verificar que la interfaz soporta modo AP
check_ap_support() {
    echo "üîç Verificando soporte de modo AP..."
    if iw list | grep -A 10 "Supported interface modes" | grep -q "AP"; then
        echo "‚úÖ La interfaz $INTERFACE soporta modo AP"
    else
        echo "‚ùå La interfaz $INTERFACE NO soporta modo AP"
        echo "   No puedes crear un hotspot con esta interfaz"
        exit 1
    fi
}

# Configurar interfaz de red para hotspot
setup_network_hotspot() {
    echo "üîß Configurando interfaz para hotspot..."
    
    # Detener NetworkManager
    sudo systemctl stop NetworkManager 2>/dev/null
    sleep 2
    
    # Limpiar configuraci√≥n anterior
    sudo ip addr flush dev $INTERFACE 2>/dev/null
    sudo ip link set $INTERFACE down
    
    # Configurar IP est√°tica para el hotspot
    sudo ip addr add $GATEWAY_IP/24 dev $INTERFACE
    sudo ip link set $INTERFACE up
    
    echo "‚úÖ Interfaz configurada con IP: $GATEWAY_IP"
}

# Configurar DNSMasq para DHCP y DNS
setup_dnsmasq_hotspot() {
    echo "üåê Configurando DNSMasq (DHCP + DNS)..."
    
    # Crear configuraci√≥n de dnsmasq
    cat > /tmp/dnsmasq_hotspot.conf << EOF
# Configuraci√≥n para Hotspot
interface=$INTERFACE
bind-interfaces

# Servidor DHCP
dhcp-range=192.168.4.10,192.168.4.100,255.255.255.0,24h
dhcp-option=3,$GATEWAY_IP  # Gateway
dhcp-option=6,$GATEWAY_IP  # DNS

# Redirecci√≥n DNS para captive portal
address=/#/$GATEWAY_IP

# Logs detallados
log-dhcp
log-queries
log-facility=/tmp/dnsmasq.log

# Opciones adicionales para mejor funcionamiento
dhcp-authoritative
dhcp-leasefile=/tmp/dhcp.leases
EOF

    # Detener cualquier dnsmasq previo
    sudo pkill dnsmasq 2>/dev/null
    sleep 2
    
    # Iniciar dnsmasq
    sudo dnsmasq -C /tmp/dnsmasq_hotspot.conf --no-daemon &
    DNSMASQ_PID=$!
    
    # Esperar a que dnsmasq inicie
    sleep 3
    if ps -p $DNSMASQ_PID > /dev/null; then
        echo "‚úÖ DNSMasq iniciado correctamente (PID: $DNSMASQ_PID)"
        echo "   - Rango DHCP: 192.168.4.10 - 192.168.4.100"
        echo "   - Gateway: $GATEWAY_IP"
        echo "   - DNS: $GATEWAY_IP"
    else
        echo "‚ùå Error: DNSMasq no se pudo iniciar"
        echo "   Revisa los logs en /tmp/dnsmasq.log"
        exit 1
    fi
}

# Configurar HostAPd para el punto de acceso
setup_hostapd() {
    echo "üì° Configurando punto de acceso WiFi..."
    
    # Crear configuraci√≥n de hostapd
    sudo tee /etc/hostapd/hostapd.conf > /dev/null <<EOF
# Configuraci√≥n b√°sica del punto de acceso
interface=$INTERFACE
driver=nl80211
ssid=$SSID
hw_mode=g
channel=6
wmm_enabled=0
macaddr_acl=0
auth_algs=1
ignore_broadcast_ssid=0

# Configuraci√≥n de seguridad WPA2
wpa=2
wpa_passphrase=$PASSWORD
wpa_key_mgmt=WPA-PSK
wpa_pairwise=TKIP
rsn_pairwise=CCMP

# Mejoras de rendimiento y compatibilidad
max_num_sta=10
logger_syslog=-1
logger_syslog_level=2
logger_stdout=-1
logger_stdout_level=2
EOF

    # Detener hostapd previo
    sudo pkill hostapd 2>/dev/null
    sleep 2
    
    # Iniciar hostapd en segundo plano con logs
    sudo hostapd -B /etc/hostapd/hostapd.conf -f /tmp/hostapd.log
    
    # Esperar a que hostapd inicie
    sleep 5
    if pgrep hostapd > /dev/null; then
        echo "‚úÖ HostAPd iniciado correctamente"
        echo "   - SSID: $SSID"
        echo "   - Canal: 6"
        echo "   - Seguridad: WPA2"
    else
        echo "‚ùå Error: HostAPd no se pudo iniciar"
        echo "   Revisa los logs en /tmp/hostapd.log"
        exit 1
    fi
}

# Configurar iptables para NAT y redirecci√≥n
setup_iptables_hotspot() {
    echo "üîÄ Configurando reglas de redirecci√≥n y NAT..."
    
    # Limpiar reglas anteriores
    sudo iptables -F
    sudo iptables -t nat -F
    sudo iptables -X
    sudo iptables -t nat -X
    
    # Politicas por defecto
    sudo iptables -P INPUT ACCEPT
    sudo iptables -P FORWARD ACCEPT
    sudo iptables -P OUTPUT ACCEPT
    
    # 1. NAT para el hotspot (MASQUERADE)
    sudo iptables -t nat -A POSTROUTING -o $INTERFACE -j MASQUERADE
    
    # 2. Redirigir HTTP (80) al servidor del captive portal
    sudo iptables -t nat -A PREROUTING -i $INTERFACE -p tcp --dport 80 -j DNAT --to-destination $GATEWAY_IP:$SERVER_PORT
    
    # 3. Redirigir HTTPS (443) al servidor del captive portal
    sudo iptables -t nat -A PREROUTING -i $INTERFACE -p tcp --dport 443 -j DNAT --to-destination $GATEWAY_IP:$SERVER_PORT
    
    # 4. Redirigir DNS (53) al servidor DNS local
    sudo iptables -t nat -A PREROUTING -i $INTERFACE -p udp --dport 53 -j DNAT --to-destination $GATEWAY_IP:53
    
    # 5. Permitir forward entre interfaces
    sudo iptables -A FORWARD -i $INTERFACE -o $INTERFACE -j ACCEPT
    
    echo "‚úÖ Reglas de iptables configuradas:"
    echo "   - NAT activado"
    echo "   - Redirecci√≥n HTTP/HTTPS/DNS"
    echo "   - Forwarding permitido"
}

# Verificar configuraci√≥n completa
verify_setup() {
    echo ""
    echo "üîç VERIFICANDO CONFIGURACI√ìN COMPLETA"
    echo "====================================="
    
    # Verificar procesos
    echo "üìä Procesos activos:"
    if pgrep hostapd > /dev/null; then
        echo "   ‚úÖ HostAPd: ACTIVO"
    else
        echo "   ‚ùå HostAPd: INACTIVO"
    fi
    
    if pgrep dnsmasq > /dev/null; then
        echo "   ‚úÖ DNSMasq: ACTIVO"
    else
        echo "   ‚ùå DNSMasq: INACTIVO"
    fi
    
    # Verificar IP de la interfaz
    echo "üåê Configuraci√≥n de red:"
    if ip addr show $INTERFACE | grep -q "192.168.4.1"; then
        echo "   ‚úÖ IP $GATEWAY_IP configurada en $INTERFACE"
    else
        echo "   ‚ùå IP NO configurada correctamente"
    fi
    
    # Verificar reglas iptables
    echo "üîÄ Reglas de redirecci√≥n:"
    sudo iptables -t nat -L PREROUTING 2>/dev/null | grep -E "(80|443|53)" && \
        echo "   ‚úÖ Reglas de redirecci√≥n activas" || \
        echo "   ‚ùå Reglas de redirecci√≥n faltantes"
    
    # Verificar que el servidor est√© listo
    echo "üêç Servidor Python:"
    if netstat -tulpn 2>/dev/null | grep ":8000" > /dev/null; then
        echo "   ‚úÖ Servidor escuchando en puerto 8000"
    else
        echo "   ‚ö†Ô∏è  Servidor no escuchando (se iniciar√° despu√©s)"
    fi
    
    echo "====================================="
}

# Informaci√≥n para el usuario
show_instructions() {
    echo ""
    echo "üéØ HOTSPOT CAPTIVE PORTAL LISTO"
    echo "==============================="
    echo "üì° RED WIFI CREADA:"
    echo "   - Nombre (SSID): $SSID"
    echo "   - Contrase√±a: $PASSWORD"
    echo "   - Seguridad: WPA2"
    echo ""
    echo "üåê CONFIGURACI√ìN DE RED:"
    echo "   - Gateway: $GATEWAY_IP"
    echo "   - Rango DHCP: 192.168.4.10 - 192.168.4.100"
    echo "   - DNS: $GATEWAY_IP"
    echo ""
    echo "üì± PARA CONECTARSE:"
    echo "1. Busca la red '$SSID' en tu tel√©fono"
    echo "2. Con√©ctate con la contrase√±a '$PASSWORD'"
    echo "3. Espera a que obtenga IP (deber√≠a ser 192.168.4.x)"
    echo "4. Abre cualquier navegador y ve a cualquier p√°gina"
    echo "5. Ser√°s redirigido autom√°ticamente al portal de login"
    echo ""
    echo "üîß CREDENCIALES DE PRUEBA:"
    echo "   Usuario: test"
    echo "   Contrase√±a: test"
    echo ""
    echo "üöÄ INICIANDO SERVIDOR CAPTIVE PORTAL..."
    echo "Presiona Ctrl+C para detener todos los servicios"
    echo "==============================="
}

# Manejar Ctrl+C para limpiar
trap cleanup EXIT

# Ejecutar configuraci√≥n paso a paso
echo "üöÄ INICIANDO CONFIGURACI√ìN..."
check_ap_support
setup_network_hotspot
setup_dnsmasq_hotspot
setup_hostapd
setup_iptables_hotspot
sleep 3
verify_setup
show_instructions

# Iniciar servidor captive portal
python3 server.py